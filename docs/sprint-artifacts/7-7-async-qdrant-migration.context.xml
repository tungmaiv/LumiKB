<story-context id="7-7-async-qdrant-migration" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>7-7</storyId>
    <title>Async Qdrant Migration</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-7-async-qdrant-migration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Qdrant client operations migrated to async implementation</iWant>
    <soThat>vector database operations don't block the event loop and API responsiveness improves under concurrent load</soThat>
    <tasks>
      <task id="1" ac="7.7.1">
        <name>Update Qdrant Client Integration</name>
        <subtasks>
          <subtask id="1.1">Update pyproject.toml to use qdrant-client[async] version</subtask>
          <subtask id="1.2">Create AsyncQdrantClient factory in app/integrations/qdrant_client.py</subtask>
          <subtask id="1.3">Update connection pool configuration for async operations</subtask>
          <subtask id="1.4">Add async client health check method</subtask>
          <subtask id="1.5">Write unit tests for async client initialization</subtask>
        </subtasks>
      </task>
      <task id="2" ac="7.7.2">
        <name>Migrate ChunkService to Async</name>
        <subtasks>
          <subtask id="2.1">Audit chunk_service.py for all sync Qdrant calls</subtask>
          <subtask id="2.2">Convert get_chunks_by_document_id to async</subtask>
          <subtask id="2.3">Convert scroll operations to async</subtask>
          <subtask id="2.4">Convert retrieve operations to async</subtask>
          <subtask id="2.5">Update callers (API endpoints) to await async methods</subtask>
          <subtask id="2.6">Write unit tests for async chunk operations</subtask>
        </subtasks>
      </task>
      <task id="3" ac="7.7.3">
        <name>Migrate SearchService to Async</name>
        <subtasks>
          <subtask id="3.1">Audit search_service.py for all sync Qdrant calls</subtask>
          <subtask id="3.2">Convert semantic_search to async</subtask>
          <subtask id="3.3">Convert similar_search to async</subtask>
          <subtask id="3.4">Convert cross_kb_search to async</subtask>
          <subtask id="3.5">Update callers (API endpoints) to await async methods</subtask>
          <subtask id="3.6">Write unit tests for async search operations</subtask>
        </subtasks>
      </task>
      <task id="4" ac="7.7.4">
        <name>Performance Validation</name>
        <subtasks>
          <subtask id="4.1">Create load test script with 100 concurrent requests</subtask>
          <subtask id="4.2">Measure response time distribution before migration</subtask>
          <subtask id="4.3">Measure response time distribution after migration</subtask>
          <subtask id="4.4">Verify no event loop blocking (consistent p99 latency)</subtask>
          <subtask id="4.5">Document performance comparison results</subtask>
        </subtasks>
      </task>
      <task id="5" ac="7.7.1,7.7.2,7.7.3,7.7.4">
        <name>Integration Testing</name>
        <subtasks>
          <subtask id="5.1">Run all existing integration tests</subtask>
          <subtask id="5.2">Verify document processing pipeline still works</subtask>
          <subtask id="5.3">Verify search functionality with async client</subtask>
          <subtask id="5.4">Fix any regressions discovered</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-7.7.1" priority="P0">
      <description>AsyncQdrantClient replaces synchronous QdrantClient in all backend services</description>
      <testable>true</testable>
      <verificationMethod>Integration test: Verify all Qdrant operations use AsyncQdrantClient, no sync QdrantClient imports in services</verificationMethod>
    </criterion>
    <criterion id="AC-7.7.2" priority="P0">
      <description>ChunkService uses native async Qdrant calls (search, scroll, retrieve)</description>
      <testable>true</testable>
      <verificationMethod>Unit test: Verify ChunkService methods are async and await Qdrant client methods directly (no asyncio.to_thread)</verificationMethod>
    </criterion>
    <criterion id="AC-7.7.3" priority="P0">
      <description>SearchService uses native async Qdrant calls for vector operations</description>
      <testable>true</testable>
      <verificationMethod>Unit test: Verify SearchService methods use await on Qdrant operations, no asyncio.to_thread wrappers</verificationMethod>
    </criterion>
    <criterion id="AC-7.7.4" priority="P1">
      <description>100 concurrent requests show consistent response times without event loop blocking</description>
      <testable>true</testable>
      <verificationMethod>Load test: 100 concurrent search requests show p99 latency &lt; 500ms with consistent distribution</verificationMethod>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md">
        <relevance>Architecture reference for Qdrant integration patterns</relevance>
        <keyInfo>
          - Vector database: Qdrant with gRPC preferred
          - KISS/DRY principles apply
          - Async-first design pattern
        </keyInfo>
      </doc>
      <doc path="docs/sprint-artifacts/tech-spec-epic-7.md">
        <relevance>Tech spec with async migration requirements</relevance>
        <keyInfo>
          - AsyncQdrantClient replaces sync client
          - Performance target: p99 &lt; 500ms under load
          - No event loop blocking
        </keyInfo>
      </doc>
      <doc path="docs/testing-guideline.md">
        <relevance>Testing patterns for async operations</relevance>
        <keyInfo>
          - pytest-asyncio for async tests
          - AsyncMock for mocking async clients
          - Testcontainers for integration tests
        </keyInfo>
      </doc>
    </docs>
    <code>
      <existing>
        <file path="backend/app/integrations/qdrant_client.py">
          <purpose>Qdrant client integration - currently uses sync QdrantClient</purpose>
          <status>EXISTS - Needs migration to AsyncQdrantClient</status>
          <keyElements>
            - QdrantService class with lazy client initialization
            - GRPC_OPTIONS configuration for connection management
            - Sync methods: create_collection, delete_collection, upsert_points
            - Uses qdrant_client.QdrantClient (sync)
            - Singleton pattern with qdrant_service instance
          </keyElements>
          <codeSnippet>
from qdrant_client import QdrantClient

class QdrantService:
    @property
    def client(self) -> QdrantClient:
        if self._client is None:
            self._client = QdrantClient(
                host=settings.qdrant_host,
                port=settings.qdrant_port,
                grpc_port=settings.qdrant_grpc_port,
                prefer_grpc=True,
                grpc_options=GRPC_OPTIONS,
            )
        return self._client
          </codeSnippet>
        </file>
        <file path="backend/app/services/chunk_service.py">
          <purpose>Chunk retrieval service - uses sync Qdrant scroll/search</purpose>
          <status>EXISTS - Needs async migration</status>
          <keyElements>
            - ChunkService class with sync methods
            - _scroll_chunks: Uses qdrant_service.client.scroll()
            - _search_chunks: Uses qdrant_service.client.search()
            - _get_chunk_count: Uses qdrant_service.client.count()
            - Cursor-based pagination for chunk retrieval
          </keyElements>
          <codeSnippet>
# Current sync pattern that needs migration:
scroll_result = qdrant_service.client.scroll(
    collection_name=self.collection_name,
    scroll_filter=scroll_filter,
    limit=limit + 1,
    with_payload=True,
    with_vectors=False,
)
          </codeSnippet>
        </file>
        <file path="backend/app/services/search_service.py">
          <purpose>Search service - uses asyncio.to_thread wrapper for Qdrant</purpose>
          <status>EXISTS - Uses asyncio.to_thread workaround, needs native async</status>
          <keyElements>
            - SearchService class with async methods
            - Uses asyncio.to_thread() to call sync Qdrant client
            - semantic_search, similar_search, cross_kb_search methods
            - Streaming support for SSE responses
            - 1152 lines of complex search logic
          </keyElements>
          <codeSnippet>
# Current asyncio.to_thread pattern that blocks thread pool:
query_response = await asyncio.to_thread(
    self.qdrant_client.query_points,
    collection_name=collection_name,
    query=embedding,
    query_filter=archive_filter,
    limit=limit,
    with_payload=True,
)
          </codeSnippet>
        </file>
        <file path="backend/app/main.py">
          <purpose>FastAPI app with Qdrant shutdown handling</purpose>
          <status>EXISTS - Calls qdrant_service.close() in lifespan</status>
        </file>
        <file path="backend/pyproject.toml">
          <purpose>Python dependencies - needs qdrant-client[async] extra</purpose>
          <status>EXISTS - Needs dependency update</status>
        </file>
      </existing>
      <toCreate>
        <file path="backend/tests/integration/test_qdrant_async.py">
          <purpose>Integration tests for async Qdrant operations</purpose>
          <pattern>pytest-asyncio with testcontainers</pattern>
        </file>
        <file path="backend/tests/performance/test_qdrant_load.py">
          <purpose>Load tests for concurrent request validation</purpose>
          <pattern>asyncio.gather with 100 concurrent requests</pattern>
        </file>
      </toCreate>
    </code>
    <dependencies>
      <backend>
        <package name="qdrant-client" version=">=1.12.0" status="EXISTS">
          <purpose>Qdrant Python client - needs [async] extra installed</purpose>
          <note>Update to qdrant-client[async] for AsyncQdrantClient</note>
        </package>
        <package name="grpcio" version=">=1.68.1" status="EXISTS">
          <purpose>gRPC support for Qdrant connection</purpose>
        </package>
        <package name="pytest-asyncio" version=">=0.25.0" status="EXISTS">
          <purpose>Async test support</purpose>
        </package>
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      Async Context Manager: AsyncQdrantClient should be used with async with for lifecycle management
    </constraint>
    <constraint type="architecture">
      No Blocking Calls: All Qdrant I/O operations must be awaited, no asyncio.to_thread wrappers
    </constraint>
    <constraint type="architecture">
      Singleton Pattern: Maintain singleton pattern for connection reuse across requests
    </constraint>
    <constraint type="performance">
      Event Loop Safety: Qdrant operations must not block the asyncio event loop
    </constraint>
    <constraint type="performance">
      p99 Latency: Under 100 concurrent requests, p99 latency must be &lt; 500ms
    </constraint>
    <constraint type="compatibility">
      Backward Compatible: API endpoints must maintain same request/response contracts
    </constraint>
  </constraints>

  <interfaces>
    <interface type="class">
      <name>AsyncQdrantClient</name>
      <description>Async Qdrant client from qdrant-client[async]</description>
      <methods>
        <method name="search" async="true">Search vectors by query</method>
        <method name="scroll" async="true">Scroll through points with pagination</method>
        <method name="query_points" async="true">Query points with filters</method>
        <method name="upsert" async="true">Insert or update points</method>
        <method name="delete" async="true">Delete points by filter</method>
      </methods>
    </interface>
    <interface type="service">
      <name>QdrantService</name>
      <description>Updated to use AsyncQdrantClient</description>
      <changes>
        - Property client returns AsyncQdrantClient
        - All collection operations become native async
        - close() method updated for async client
      </changes>
    </interface>
    <interface type="service">
      <name>ChunkService</name>
      <description>Updated to use native async Qdrant calls</description>
      <changes>
        - Remove asyncio.to_thread wrappers
        - Use await client.scroll() directly
        - Use await client.search() directly
      </changes>
    </interface>
    <interface type="service">
      <name>SearchService</name>
      <description>Updated to use native async Qdrant calls</description>
      <changes>
        - Remove asyncio.to_thread wrappers
        - Use await client.query_points() directly
        - Maintain streaming support
      </changes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard>Unit tests: Use AsyncMock for Qdrant client operations</standard>
      <standard>Integration tests: Use testcontainers for real Qdrant instance</standard>
      <standard>Performance tests: 100 concurrent requests with consistent p99</standard>
      <standard>Coverage target: 80% for modified services</standard>
    </standards>
    <locations>
      <location path="backend/tests/unit/test_chunk_service.py">Unit tests for async chunk operations</location>
      <location path="backend/tests/unit/test_search_service.py">Unit tests for async search operations</location>
      <location path="backend/tests/integration/test_qdrant_async.py">Integration tests for async client</location>
      <location path="backend/tests/performance/test_qdrant_load.py">Load tests for concurrent validation</location>
    </locations>
    <ideas>
      <idea ac="7.7.1">
        Test AsyncQdrantClient initializes with correct gRPC options
      </idea>
      <idea ac="7.7.1">
        Test async client health_check returns True when Qdrant is available
      </idea>
      <idea ac="7.7.2">
        Test ChunkService._scroll_chunks is async and awaits client.scroll
      </idea>
      <idea ac="7.7.2">
        Test ChunkService._search_chunks is async and awaits client.search
      </idea>
      <idea ac="7.7.3">
        Test SearchService.semantic_search uses native async without to_thread
      </idea>
      <idea ac="7.7.3">
        Test SearchService.cross_kb_search awaits multiple async operations
      </idea>
      <idea ac="7.7.4">
        Load test: 100 concurrent search requests complete within p99 &lt; 500ms
      </idea>
      <idea ac="7.7.4">
        Load test: No event loop blocking detected (response times consistent)
      </idea>
    </ideas>
  </tests>
</story-context>
