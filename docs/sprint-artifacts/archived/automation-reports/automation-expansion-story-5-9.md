# Automation Expansion: Story 5.9 - Recent KBs and Polish Items

**Generated by:** TEA (Test Engineering Architect)
**Date:** 2025-12-03
**Story:** 5.9 - Recent KBs and Polish Items
**Status:** Ready for Implementation

---

## Executive Summary

Story 5.9 has solid backend test coverage (20 tests) and frontend hook tests (18 tests). However, critical gaps exist in:

1. **KB Sidebar Recent/Recommendations UI** - Component tests don't verify new sections
2. **Error Boundary Component** - Zero test coverage for a critical resilience feature
3. **Keyboard Accessibility** - No automated WCAG validation
4. **Integration Flow** - Recent KB click → navigation → active KB state

**Risk Level:** MEDIUM-HIGH
**Recommended Action:** Add 24 new tests before marking story complete

---

## Test Gap Analysis

### 1. Current Coverage Matrix

| Component | AC Coverage | Unit | Integration | E2E | Gap |
|-----------|------------|------|-------------|-----|-----|
| Recent KBs Backend | AC-5.9.1, AC-5.9.2 | 10 | 10 | - | None |
| `useRecentKBs` Hook | AC-5.9.1 | 8 | - | - | None |
| `useKBRecommendations` Hook | AC-5.9.6 | 10 | - | - | None |
| KB Sidebar - Recent Section | AC-5.9.1, AC-5.9.4 | 0 | - | - | **HIGH** |
| KB Sidebar - Recommendations | AC-5.9.6 | 0 | - | - | **HIGH** |
| KB Sidebar - Empty State | AC-5.9.3 | 0 | - | - | **MEDIUM** |
| Error Boundary | AC-5.9.8 | 0 | - | - | **HIGH** |
| Loading Skeletons | AC-5.9.7 | 1 | - | - | **LOW** |
| Tooltips | AC-5.9.5 | 0 | - | - | **MEDIUM** |
| Keyboard Navigation | AC-5.9.9 | 0 | - | - | **HIGH** |

### 2. Risk-Prioritized Test Additions

**Priority 1 (Critical - AC Compliance):**
- Error Boundary tests (AC-5.9.8)
- KB Sidebar Recent Section tests (AC-5.9.1, AC-5.9.4)
- Keyboard Navigation tests (AC-5.9.9)

**Priority 2 (High - User Experience):**
- KB Sidebar Recommendations tests (AC-5.9.6)
- Empty State rendering tests (AC-5.9.3)

**Priority 3 (Medium - Polish):**
- Tooltip interaction tests (AC-5.9.5)
- Loading skeleton dimension tests (AC-5.9.7)

---

## Test Specifications

### Test Suite 1: KB Sidebar Recent Section (`kb-sidebar-recent.test.tsx`)

**File:** `frontend/src/components/layout/__tests__/kb-sidebar-recent.test.tsx`

```typescript
// Test Specifications - KB Sidebar Recent Section

describe('KbSidebar - Recent KBs Section', () => {
  // AC-5.9.1: Recent KBs display
  describe('Recent KBs Display', () => {
    it('renders Recent section header with Clock icon when KBs exist');
    it('displays up to 5 recent KBs in order');
    it('shows KB name and document count for each recent KB');
    it('truncates long KB names with ellipsis');
    it('hides Recent section when no recent KBs');
  });

  // AC-5.9.4: Click navigation
  describe('Recent KB Navigation', () => {
    it('calls setActiveKb when recent KB is clicked');
    it('navigates to search page with kb query param');
    it('handles click on KB not in store gracefully');
  });

  // Loading states
  describe('Loading States', () => {
    it('shows RecentKbsSkeleton during loading');
    it('hides skeleton when data loads');
  });
});
```

**Test Count:** 10 tests
**Priority:** P1
**AC Coverage:** AC-5.9.1, AC-5.9.4

---

### Test Suite 2: KB Sidebar Recommendations Section

**File:** `frontend/src/components/layout/__tests__/kb-sidebar-recommendations.test.tsx`

```typescript
// Test Specifications - KB Sidebar Recommendations Section

describe('KbSidebar - Recommendations Section', () => {
  // AC-5.9.6: KB Recommendations integration
  describe('Recommendations Display', () => {
    it('shows Recommendations section only when user has no history');
    it('hides Recommendations when user has recent KBs');
    it('displays up to 3 recommendations');
    it('shows Sparkles icon and "Suggested for you" header');
    it('displays reason in tooltip on hover');
  });

  describe('Recommendation Navigation', () => {
    it('calls setActiveKb when recommendation is clicked');
    it('navigates to search page with kb query param');
  });

  describe('Cold Start Handling', () => {
    it('shows recommendations for new users with no history');
    it('handles empty recommendations gracefully');
  });
});
```

**Test Count:** 9 tests
**Priority:** P2
**AC Coverage:** AC-5.9.6

---

### Test Suite 3: Error Boundary Component

**File:** `frontend/src/components/error/__tests__/error-boundary.test.tsx`

```typescript
// Test Specifications - Error Boundary

describe('ErrorBoundary', () => {
  // AC-5.9.8: Error boundaries with recovery
  describe('Error Catching', () => {
    it('catches errors in child components');
    it('displays fallback UI when error occurs');
    it('shows error message in development mode');
    it('hides error details in production mode');
    it('logs error to console');
  });

  describe('Recovery', () => {
    it('resets error state when Try Again is clicked');
    it('re-renders children after reset');
    it('calls onError callback when error occurs');
  });

  describe('Custom Fallback', () => {
    it('renders custom fallback when provided');
    it('uses default fallback when not provided');
  });

  describe('InlineErrorFallback', () => {
    it('renders inline error message');
    it('shows retry button when onRetry provided');
    it('hides retry button when onRetry not provided');
    it('calls onRetry when button clicked');
  });
});
```

**Test Count:** 13 tests
**Priority:** P1
**AC Coverage:** AC-5.9.8

---

### Test Suite 4: Keyboard Accessibility

**File:** `frontend/src/components/layout/__tests__/kb-sidebar-a11y.test.tsx`

```typescript
// Test Specifications - Keyboard Accessibility

describe('KbSidebar - Keyboard Accessibility', () => {
  // AC-5.9.9: Keyboard navigation
  describe('Tab Order', () => {
    it('tab moves focus to Create KB button first');
    it('tab moves through recent KB items in order');
    it('tab moves through all KB items in order');
    it('shift+tab moves focus backwards');
  });

  describe('Focus Indicators', () => {
    it('shows focus ring on focused KB item');
    it('focus ring has sufficient contrast');
    it('focus-visible class applied on keyboard focus');
  });

  describe('Activation', () => {
    it('Enter key activates focused KB item');
    it('Space key activates focused button');
  });

  describe('ARIA', () => {
    it('KB items have aria-label with KB name');
    it('Create button has aria-label');
    it('Recent section has appropriate heading');
  });
});
```

**Test Count:** 12 tests
**Priority:** P1
**AC Coverage:** AC-5.9.9

---

### Test Suite 5: Empty State and Loading Skeletons

**File:** `frontend/src/components/layout/__tests__/kb-sidebar-states.test.tsx`

```typescript
// Test Specifications - States

describe('KbSidebar - States', () => {
  // AC-5.9.3: Empty state
  describe('Empty State', () => {
    it('shows "No recent activity" message for new users');
    it('shows "Select a KB below" subtext');
    it('shows empty state icon');
  });

  // AC-5.9.7: Loading skeletons
  describe('Loading Skeletons', () => {
    it('shows KbSelectorSkeleton during KB list loading');
    it('shows RecentKbsSkeleton during recent loading');
    it('skeleton dimensions match actual components');
    it('skeletons have pulse animation');
  });

  describe('All KBs Section', () => {
    it('shows "All Knowledge Bases" header when recent/recommendations exist');
    it('hides header when no recent or recommendations');
  });
});
```

**Test Count:** 9 tests
**Priority:** P2
**AC Coverage:** AC-5.9.3, AC-5.9.7

---

## Implementation Files

### File 1: `kb-sidebar-recent.test.tsx`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { KbSidebar } from '../../layout/kb-sidebar';
import type { KnowledgeBase } from '@/lib/api/knowledge-bases';
import type { RecentKB } from '@/hooks/useRecentKBs';

// Mock next/navigation
const mockPush = vi.fn();
vi.mock('next/navigation', () => ({
  useRouter: () => ({ push: mockPush }),
}));

// Mock KB store
const mockSetActiveKb = vi.fn();
const mockFetchKbs = vi.fn();

const mockKbs: KnowledgeBase[] = [
  {
    id: 'kb-1',
    name: 'Test KB 1',
    description: 'Description 1',
    status: 'active',
    document_count: 5,
    permission_level: 'ADMIN',
    created_at: '2024-01-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
  {
    id: 'kb-2',
    name: 'Test KB 2',
    description: 'Description 2',
    status: 'active',
    document_count: 10,
    permission_level: 'READ',
    created_at: '2024-01-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
];

let mockKBStoreState = {
  kbs: mockKbs,
  activeKb: null as KnowledgeBase | null,
  isLoading: false,
  error: null as string | null,
  fetchKbs: mockFetchKbs,
  setActiveKb: mockSetActiveKb,
  createKb: vi.fn(),
  clearError: vi.fn(),
};

vi.mock('@/lib/stores/kb-store', () => ({
  useKBStore: (selector?: (state: typeof mockKBStoreState) => unknown) => {
    if (selector) return selector(mockKBStoreState);
    return mockKBStoreState;
  },
}));

vi.mock('@/lib/stores/auth-store', () => ({
  useAuthStore: (selector?: (state: { user: { id: string } | null }) => unknown) => {
    const state = { user: { id: 'user-1' } };
    if (selector) return selector(state);
    return state;
  },
}));

// Mock Recent KBs hook
const mockRecentKBs: RecentKB[] = [
  {
    kb_id: 'kb-1',
    kb_name: 'Test KB 1',
    description: 'Description 1',
    last_accessed: '2025-12-03T10:00:00Z',
    document_count: 5,
  },
  {
    kb_id: 'kb-2',
    kb_name: 'Test KB 2',
    description: 'Description 2',
    last_accessed: '2025-12-03T09:00:00Z',
    document_count: 10,
  },
];

let mockRecentKBsHook = {
  data: mockRecentKBs,
  isLoading: false,
  isError: false,
  error: null,
};

vi.mock('@/hooks/useRecentKBs', () => ({
  useRecentKBs: () => mockRecentKBsHook,
}));

// Mock KB Recommendations hook
vi.mock('@/hooks/useKBRecommendations', () => ({
  useKBRecommendations: () => ({
    data: [],
    isLoading: false,
    isError: false,
    error: null,
  }),
}));

describe('KbSidebar - Recent KBs Section', () => {
  let queryClient: QueryClient;

  beforeEach(() => {
    vi.clearAllMocks();
    mockPush.mockClear();
    mockSetActiveKb.mockClear();
    queryClient = new QueryClient({
      defaultOptions: { queries: { retry: false } },
    });
    mockRecentKBsHook = {
      data: mockRecentKBs,
      isLoading: false,
      isError: false,
      error: null,
    };
    mockKBStoreState = {
      kbs: mockKbs,
      activeKb: null,
      isLoading: false,
      error: null,
      fetchKbs: mockFetchKbs,
      setActiveKb: mockSetActiveKb,
      createKb: vi.fn(),
      clearError: vi.fn(),
    };
  });

  const renderWithProviders = () => {
    return render(
      <QueryClientProvider client={queryClient}>
        <KbSidebar />
      </QueryClientProvider>
    );
  };

  describe('Recent KBs Display (AC-5.9.1)', () => {
    it('renders Recent section header with Clock icon when KBs exist', () => {
      renderWithProviders();

      expect(screen.getByText('Recent')).toBeInTheDocument();
      // Clock icon is rendered (check for SVG with specific class)
      const clockIcon = document.querySelector('[class*="lucide-clock"]');
      expect(clockIcon).toBeTruthy();
    });

    it('displays up to 5 recent KBs in order', () => {
      renderWithProviders();

      // Both recent KBs should be displayed
      expect(screen.getByText('Test KB 1')).toBeInTheDocument();
      expect(screen.getByText('Test KB 2')).toBeInTheDocument();
    });

    it('shows KB name and document count for each recent KB', () => {
      renderWithProviders();

      expect(screen.getByText('5 docs')).toBeInTheDocument();
      expect(screen.getByText('10 docs')).toBeInTheDocument();
    });

    it('truncates long KB names with ellipsis', () => {
      mockRecentKBsHook.data = [
        {
          kb_id: 'kb-long',
          kb_name: 'This is a very long knowledge base name that should be truncated',
          description: 'Long description',
          last_accessed: '2025-12-03T10:00:00Z',
          document_count: 5,
        },
      ];
      mockKBStoreState.kbs = [
        {
          id: 'kb-long',
          name: 'This is a very long knowledge base name that should be truncated',
          description: 'Long description',
          status: 'active',
          document_count: 5,
          permission_level: 'READ',
          created_at: '2024-01-01T00:00:00Z',
          updated_at: '2024-01-01T00:00:00Z',
        },
      ];

      renderWithProviders();

      const kbNameElement = screen.getByText(
        'This is a very long knowledge base name that should be truncated'
      );
      expect(kbNameElement).toHaveClass('truncate');
    });

    it('hides Recent section when no recent KBs', () => {
      mockRecentKBsHook.data = [];

      renderWithProviders();

      expect(screen.queryByText('Recent')).not.toBeInTheDocument();
    });
  });

  describe('Recent KB Navigation (AC-5.9.4)', () => {
    it('calls setActiveKb when recent KB is clicked', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      await user.click(screen.getByLabelText('Open Test KB 1'));

      expect(mockSetActiveKb).toHaveBeenCalledWith(mockKbs[0]);
    });

    it('navigates to search page with kb query param', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      await user.click(screen.getByLabelText('Open Test KB 1'));

      expect(mockPush).toHaveBeenCalledWith('/search?kb=kb-1');
    });

    it('handles click on KB not in store gracefully', async () => {
      const user = userEvent.setup();
      mockRecentKBsHook.data = [
        {
          kb_id: 'kb-not-in-store',
          kb_name: 'Missing KB',
          description: 'Not in store',
          last_accessed: '2025-12-03T10:00:00Z',
          document_count: 0,
        },
      ];

      renderWithProviders();

      await user.click(screen.getByLabelText('Open Missing KB'));

      // Should still navigate even if KB not in store
      expect(mockPush).toHaveBeenCalledWith('/search?kb=kb-not-in-store');
      // setActiveKb should not be called since KB not found
      expect(mockSetActiveKb).not.toHaveBeenCalled();
    });
  });

  describe('Loading States', () => {
    it('shows RecentKbsSkeleton during loading', () => {
      mockRecentKBsHook.isLoading = true;
      mockRecentKBsHook.data = undefined as unknown as RecentKB[];

      renderWithProviders();

      // Should show skeleton elements
      const skeletons = document.querySelectorAll('[class*="animate-pulse"]');
      expect(skeletons.length).toBeGreaterThan(0);
    });

    it('hides skeleton when data loads', async () => {
      mockRecentKBsHook.isLoading = false;

      renderWithProviders();

      // Should show actual KB names, not skeletons in Recent section
      expect(screen.getByText('Test KB 1')).toBeInTheDocument();
    });
  });
});
```

---

### File 2: `error-boundary.test.tsx`

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { ErrorBoundary, InlineErrorFallback } from '../error-boundary';

// Component that throws an error
function ThrowError({ shouldThrow }: { shouldThrow: boolean }): React.ReactElement | null {
  if (shouldThrow) {
    throw new Error('Test error message');
  }
  return <div>Child content</div>;
}

describe('ErrorBoundary', () => {
  let consoleErrorSpy: ReturnType<typeof vi.spyOn>;
  const originalNodeEnv = process.env.NODE_ENV;

  beforeEach(() => {
    // Suppress console.error for cleaner test output
    consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {});
  });

  afterEach(() => {
    consoleErrorSpy.mockRestore();
    process.env.NODE_ENV = originalNodeEnv;
  });

  describe('Error Catching (AC-5.9.8)', () => {
    it('catches errors in child components', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.getByTestId('error-boundary-fallback')).toBeInTheDocument();
    });

    it('displays fallback UI when error occurs', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Something went wrong')).toBeInTheDocument();
      expect(
        screen.getByText('An error occurred while loading this content')
      ).toBeInTheDocument();
    });

    it('shows error message in development mode', () => {
      process.env.NODE_ENV = 'development';

      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Test error message')).toBeInTheDocument();
    });

    it('hides error details in production mode', () => {
      process.env.NODE_ENV = 'production';

      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.queryByText('Test error message')).not.toBeInTheDocument();
    });

    it('logs error to console', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(consoleErrorSpy).toHaveBeenCalledWith(
        'ErrorBoundary caught an error:',
        expect.any(Error),
        expect.any(Object)
      );
    });
  });

  describe('Recovery', () => {
    it('resets error state when Try Again is clicked', () => {
      const { rerender } = render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      // Click Try Again
      fireEvent.click(screen.getByText('Try again'));

      // Re-render with non-throwing component
      rerender(
        <ErrorBoundary>
          <ThrowError shouldThrow={false} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Child content')).toBeInTheDocument();
    });

    it('re-renders children after reset', () => {
      let shouldThrow = true;

      const { rerender } = render(
        <ErrorBoundary>
          <ThrowError shouldThrow={shouldThrow} />
        </ErrorBoundary>
      );

      expect(screen.getByTestId('error-boundary-fallback')).toBeInTheDocument();

      // Click Try Again and change state
      fireEvent.click(screen.getByText('Try again'));
      shouldThrow = false;

      rerender(
        <ErrorBoundary>
          <ThrowError shouldThrow={shouldThrow} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Child content')).toBeInTheDocument();
    });

    it('calls onError callback when error occurs', () => {
      const onError = vi.fn();

      render(
        <ErrorBoundary onError={onError}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(onError).toHaveBeenCalledWith(
        expect.any(Error),
        expect.objectContaining({ componentStack: expect.any(String) })
      );
    });
  });

  describe('Custom Fallback', () => {
    it('renders custom fallback when provided', () => {
      render(
        <ErrorBoundary fallback={<div>Custom error UI</div>}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Custom error UI')).toBeInTheDocument();
      expect(screen.queryByText('Something went wrong')).not.toBeInTheDocument();
    });

    it('uses default fallback when not provided', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Something went wrong')).toBeInTheDocument();
    });
  });

  describe('Renders children when no error', () => {
    it('renders children normally when no error occurs', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={false} />
        </ErrorBoundary>
      );

      expect(screen.getByText('Child content')).toBeInTheDocument();
      expect(screen.queryByTestId('error-boundary-fallback')).not.toBeInTheDocument();
    });
  });
});

describe('InlineErrorFallback', () => {
  it('renders inline error message', () => {
    render(<InlineErrorFallback message="Failed to load data" />);

    expect(screen.getByTestId('inline-error-fallback')).toBeInTheDocument();
    expect(screen.getByText('Failed to load data')).toBeInTheDocument();
  });

  it('shows retry button when onRetry provided', () => {
    const onRetry = vi.fn();
    render(<InlineErrorFallback message="Error" onRetry={onRetry} />);

    expect(screen.getByRole('button')).toBeInTheDocument();
  });

  it('hides retry button when onRetry not provided', () => {
    render(<InlineErrorFallback message="Error" />);

    expect(screen.queryByRole('button')).not.toBeInTheDocument();
  });

  it('calls onRetry when button clicked', () => {
    const onRetry = vi.fn();
    render(<InlineErrorFallback message="Error" onRetry={onRetry} />);

    fireEvent.click(screen.getByRole('button'));

    expect(onRetry).toHaveBeenCalledTimes(1);
  });

  it('uses default message when not provided', () => {
    render(<InlineErrorFallback />);

    expect(screen.getByText('Failed to load')).toBeInTheDocument();
  });
});
```

---

### File 3: `kb-sidebar-a11y.test.tsx`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { KbSidebar } from '../../layout/kb-sidebar';
import type { KnowledgeBase } from '@/lib/api/knowledge-bases';

// Mock next/navigation
vi.mock('next/navigation', () => ({
  useRouter: () => ({ push: vi.fn() }),
}));

// Mock stores and hooks (same as kb-sidebar-recent.test.tsx)
const mockKbs: KnowledgeBase[] = [
  {
    id: 'kb-1',
    name: 'Test KB 1',
    description: 'Description 1',
    status: 'active',
    document_count: 5,
    permission_level: 'ADMIN',
    created_at: '2024-01-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
  {
    id: 'kb-2',
    name: 'Test KB 2',
    description: 'Description 2',
    status: 'active',
    document_count: 10,
    permission_level: 'READ',
    created_at: '2024-01-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
];

const mockSetActiveKb = vi.fn();

vi.mock('@/lib/stores/kb-store', () => ({
  useKBStore: () => ({
    kbs: mockKbs,
    activeKb: null,
    isLoading: false,
    error: null,
    fetchKbs: vi.fn(),
    setActiveKb: mockSetActiveKb,
    createKb: vi.fn(),
    clearError: vi.fn(),
  }),
}));

vi.mock('@/lib/stores/auth-store', () => ({
  useAuthStore: () => ({ user: { id: 'user-1' } }),
}));

vi.mock('@/hooks/useRecentKBs', () => ({
  useRecentKBs: () => ({
    data: [
      {
        kb_id: 'kb-1',
        kb_name: 'Test KB 1',
        description: 'Description 1',
        last_accessed: '2025-12-03T10:00:00Z',
        document_count: 5,
      },
    ],
    isLoading: false,
  }),
}));

vi.mock('@/hooks/useKBRecommendations', () => ({
  useKBRecommendations: () => ({
    data: [],
    isLoading: false,
  }),
}));

describe('KbSidebar - Keyboard Accessibility (AC-5.9.9)', () => {
  let queryClient: QueryClient;

  beforeEach(() => {
    vi.clearAllMocks();
    queryClient = new QueryClient({
      defaultOptions: { queries: { retry: false } },
    });
  });

  const renderWithProviders = () => {
    return render(
      <QueryClientProvider client={queryClient}>
        <KbSidebar />
      </QueryClientProvider>
    );
  };

  describe('Tab Order', () => {
    it('tab moves focus to Create KB button first', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      await user.tab();

      expect(screen.getByLabelText('Create Knowledge Base')).toHaveFocus();
    });

    it('tab moves through recent KB items in order', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab to Create button
      await user.tab();
      // Tab to first recent KB
      await user.tab();

      expect(screen.getByLabelText('Open Test KB 1')).toHaveFocus();
    });

    it('tab moves through all KB items in order', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab through interactive elements
      await user.tab(); // Create button
      await user.tab(); // First recent KB
      await user.tab(); // First KB in list
      await user.tab(); // Second KB in list

      // Should be on second KB item
      const kbButtons = screen.getAllByRole('button').filter(
        (btn) => btn.textContent?.includes('Test KB')
      );
      expect(kbButtons.length).toBeGreaterThan(0);
    });

    it('shift+tab moves focus backwards', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab forward twice
      await user.tab();
      await user.tab();

      // Shift+tab back
      await user.tab({ shift: true });

      expect(screen.getByLabelText('Create Knowledge Base')).toHaveFocus();
    });
  });

  describe('Focus Indicators', () => {
    it('shows focus ring on focused KB item', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab to recent KB
      await user.tab();
      await user.tab();

      const focusedElement = document.activeElement;
      expect(focusedElement).toHaveClass('focus-visible:ring-2');
    });

    it('focus-visible class applied on keyboard focus', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      await user.tab();

      const createButton = screen.getByLabelText('Create Knowledge Base');
      // Button should have focus-visible styling classes
      expect(createButton.className).toContain('focus');
    });
  });

  describe('Activation', () => {
    it('Enter key activates focused KB item', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab to recent KB
      await user.tab();
      await user.tab();

      // Press Enter
      await user.keyboard('{Enter}');

      expect(mockSetActiveKb).toHaveBeenCalled();
    });

    it('Space key activates focused button', async () => {
      const user = userEvent.setup();
      renderWithProviders();

      // Tab to Create button
      await user.tab();

      // Press Space
      await user.keyboard(' ');

      // Modal should open - check for modal content
      expect(screen.getByText('Create Knowledge Base')).toBeInTheDocument();
    });
  });

  describe('ARIA', () => {
    it('KB items have aria-label with KB name', () => {
      renderWithProviders();

      expect(screen.getByLabelText('Open Test KB 1')).toBeInTheDocument();
    });

    it('Create button has aria-label', () => {
      renderWithProviders();

      expect(screen.getByLabelText('Create Knowledge Base')).toBeInTheDocument();
    });

    it('Recent section has appropriate heading', () => {
      renderWithProviders();

      // "Recent" text should be present as a heading-like element
      const recentHeading = screen.getByText('Recent');
      expect(recentHeading.tagName.toLowerCase()).toBe('span');
      expect(recentHeading).toHaveClass('uppercase');
    });
  });
});
```

---

## E2E Test Stubs (Deferred to Story 5.16)

**File:** `frontend/e2e/tests/sidebar/recent-kbs.spec.ts`

```typescript
// E2E Test Stub - To be implemented in Story 5.16

import { test, expect } from '@playwright/test';

test.describe('Recent KBs Sidebar', () => {
  test.skip('displays recent KBs after user accesses a KB', async ({ page }) => {
    // 1. Login as test user
    // 2. Access a KB via search
    // 3. Navigate to dashboard
    // 4. Verify KB appears in Recent section
    // 5. Click recent KB → verify navigation to search
  });

  test.skip('shows empty state for new users', async ({ page }) => {
    // 1. Register new user
    // 2. Login
    // 3. Verify Recent section is empty
    // 4. Verify "Suggested for you" section visible (if recommendations exist)
  });

  test.skip('limits recent KBs to 5', async ({ page }) => {
    // 1. Login as user with 10+ KB accesses
    // 2. Verify only 5 recent KBs shown
    // 3. Verify most recent is first
  });

  test.skip('keyboard navigation through sidebar', async ({ page }) => {
    // 1. Login
    // 2. Tab through sidebar elements
    // 3. Verify focus order
    // 4. Press Enter on KB → verify activation
  });
});
```

---

## Test Execution Plan

### Phase 1: Critical Tests (P1)
```bash
# Run error boundary tests
npm run test -- src/components/error/__tests__/error-boundary.test.tsx

# Run KB sidebar recent section tests
npm run test -- src/components/layout/__tests__/kb-sidebar-recent.test.tsx

# Run accessibility tests
npm run test -- src/components/layout/__tests__/kb-sidebar-a11y.test.tsx
```

### Phase 2: High Priority Tests (P2)
```bash
# Run recommendations section tests
npm run test -- src/components/layout/__tests__/kb-sidebar-recommendations.test.tsx

# Run states tests (empty, loading)
npm run test -- src/components/layout/__tests__/kb-sidebar-states.test.tsx
```

### Phase 3: Full Suite
```bash
# Run all frontend tests
npm run test

# Run with coverage
npm run test -- --coverage
```

---

## Traceability Matrix

| AC ID | Test File | Test Count | Priority |
|-------|-----------|------------|----------|
| AC-5.9.1 | `kb-sidebar-recent.test.tsx` | 8 | P1 |
| AC-5.9.3 | `kb-sidebar-states.test.tsx` | 3 | P2 |
| AC-5.9.4 | `kb-sidebar-recent.test.tsx` | 3 | P1 |
| AC-5.9.5 | Manual + future tooltip tests | 0 | P3 |
| AC-5.9.6 | `kb-sidebar-recommendations.test.tsx` | 9 | P2 |
| AC-5.9.7 | `kb-sidebar-states.test.tsx` | 4 | P2 |
| AC-5.9.8 | `error-boundary.test.tsx` | 13 | P1 |
| AC-5.9.9 | `kb-sidebar-a11y.test.tsx` | 12 | P1 |

---

## Summary

| Metric | Current | After Expansion |
|--------|---------|-----------------|
| Backend Unit Tests | 10 | 10 (no change) |
| Backend Integration Tests | 10 | 10 (no change) |
| Frontend Hook Tests | 18 | 18 (no change) |
| Frontend Component Tests | 12 | **65** (+53) |
| E2E Tests | 0 | 4 stubs (5.16) |
| **Total Tests** | **50** | **103** |

**Confidence Level:** HIGH after expansion
**Risk Mitigation:** Error boundary + accessibility tests address critical gaps
