<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: Auto-generated context file for Story 1.5
  Generated: 2025-11-23
  DO NOT EDIT MANUALLY - regenerate with *create-story-context
-->
<story-context story-id="1.5" epic-id="1">
  <metadata>
    <title>User Profile and Password Management Backend</title>
    <story-key>1-5-user-profile-and-password-management-backend</story-key>
    <epic>Foundation &amp; Authentication</epic>
    <status>drafted</status>
    <generated>2025-11-23</generated>
  </metadata>

  <user-story>
    <as-a>user</as-a>
    <i-want>to update my profile and reset my password</i-want>
    <so-that>I can manage my account information</so-that>
  </user-story>

  <acceptance-criteria>
    <criterion id="AC1">
      <given>I am logged in</given>
      <when>I call GET /api/v1/users/me</when>
      <then>I receive my profile information (email, name, created_at)</then>
    </criterion>
    <criterion id="AC2">
      <given>I am logged in</given>
      <when>I call PATCH /api/v1/users/me with valid data</when>
      <then>My profile is updated AND the change is logged to audit.events</then>
    </criterion>
    <criterion id="AC3">
      <given>I forgot my password</given>
      <when>I submit my email to password reset endpoint</when>
      <then>A reset token is generated (expires in 1 hour) AND (mock) email would be sent with reset link</then>
    </criterion>
    <criterion id="AC4">
      <given>I have a valid reset token</given>
      <when>I submit a new password</when>
      <then>My password is updated AND all existing sessions are invalidated AND the change is logged to audit.events</then>
    </criterion>
    <criterion id="AC5">
      <given>I have an expired or invalid reset token</given>
      <when>I try to reset my password</when>
      <then>I receive an appropriate error response (400 Bad Request)</then>
    </criterion>
    <criterion id="AC6">
      <given>I am logged in</given>
      <when>I call PATCH /api/v1/users/me with invalid data (e.g., invalid email format)</when>
      <then>I receive 422 Validation Error with details</then>
    </criterion>
    <criterion id="AC7">
      <given>I reset my password successfully</given>
      <when>I try to access protected endpoints with old session</when>
      <then>I receive 401 Unauthorized (session invalidated)</then>
    </criterion>
    <criterion id="AC8">
      <given>I am not logged in</given>
      <when>I call PATCH /api/v1/users/me</when>
      <then>I receive 401 Unauthorized</then>
    </criterion>
    <criterion id="AC9">
      <given>Any profile or password change occurs</given>
      <when>The operation completes</when>
      <then>An audit event is logged with action, user_id, ip_address, and timestamp</then>
    </criterion>
  </acceptance-criteria>

  <tasks>
    <task id="T1" status="todo">
      <title>Implement PATCH /api/v1/users/me endpoint</title>
      <description>Allow users to update their profile (email, name fields). Validate input and update in database.</description>
      <files>
        <file>backend/app/api/v1/users.py</file>
        <file>backend/app/schemas/user.py</file>
      </files>
    </task>
    <task id="T2" status="todo">
      <title>Implement POST /api/v1/auth/forgot-password endpoint</title>
      <description>Generate password reset token using FastAPI-Users, mock email sending (log to console).</description>
      <files>
        <file>backend/app/api/v1/auth.py</file>
        <file>backend/app/core/auth.py</file>
      </files>
    </task>
    <task id="T3" status="todo">
      <title>Implement POST /api/v1/auth/reset-password endpoint</title>
      <description>Accept token and new password, validate token, update password, invalidate all sessions.</description>
      <files>
        <file>backend/app/api/v1/auth.py</file>
        <file>backend/app/core/auth.py</file>
        <file>backend/app/core/redis.py</file>
      </files>
    </task>
    <task id="T4" status="todo">
      <title>Implement session invalidation for password reset</title>
      <description>Add method to RedisSessionStore to invalidate ALL sessions for a user (not just one).</description>
      <files>
        <file>backend/app/core/redis.py</file>
      </files>
    </task>
    <task id="T5" status="todo">
      <title>Add UserUpdate schema fields</title>
      <description>Extend UserUpdate schema if needed for profile fields (first_name, last_name if applicable).</description>
      <files>
        <file>backend/app/schemas/user.py</file>
      </files>
    </task>
    <task id="T6" status="todo">
      <title>Add audit logging for profile and password changes</title>
      <description>Call audit_service.log_event for profile updates, password reset requests, and password changes.</description>
      <files>
        <file>backend/app/api/v1/users.py</file>
        <file>backend/app/api/v1/auth.py</file>
        <file>backend/app/services/audit_service.py</file>
      </files>
    </task>
    <task id="T7" status="todo">
      <title>Write integration tests for all new endpoints</title>
      <description>Test PATCH /users/me, forgot-password, reset-password with valid/invalid cases.</description>
      <files>
        <file>backend/tests/integration/test_users.py</file>
      </files>
    </task>
    <task id="T8" status="todo">
      <title>Verify all acceptance criteria are met</title>
      <description>Manual verification and test coverage review.</description>
      <files></files>
    </task>
  </tasks>

  <technical-context>
    <architecture-decisions>
      <decision id="AD1">
        <title>FastAPI-Users Integration</title>
        <description>Use FastAPI-Users built-in password reset flow with custom UserManager hooks. Token generation and validation handled by the library.</description>
        <rationale>FastAPI-Users provides secure, tested password reset functionality out of the box. Custom hooks allow audit logging integration.</rationale>
        <reference>docs/architecture.md - Security Architecture section</reference>
      </decision>
      <decision id="AD2">
        <title>Session Invalidation Pattern</title>
        <description>Store sessions with user_id prefix in Redis. On password reset, delete ALL keys matching session:user_id:* pattern OR store session list per user.</description>
        <rationale>Security requirement - password reset must invalidate all existing sessions to prevent unauthorized access.</rationale>
        <current-impl>Current impl uses session:uuid key per user. Need to track multiple sessions or use wildcard deletion.</current-impl>
      </decision>
      <decision id="AD3">
        <title>Mock Email for MVP</title>
        <description>Email sending is mocked for MVP. Log reset token to console/structlog instead of sending actual email.</description>
        <rationale>Email infrastructure is out of scope for MVP. Logging allows manual testing of password reset flow.</rationale>
      </decision>
      <decision id="AD4">
        <title>Audit Logging Pattern</title>
        <description>Use fire-and-forget background tasks for audit logging to not block request processing.</description>
        <reference>docs/sprint-artifacts/tech-spec-epic-1.md - Section 4.3</reference>
      </decision>
    </architecture-decisions>

    <existing-interfaces>
      <interface type="api">
        <name>GET /api/v1/users/me</name>
        <status>implemented</status>
        <file>backend/app/api/v1/users.py:16-34</file>
        <description>Returns UserRead schema for current authenticated user. Already working.</description>
      </interface>
      <interface type="api">
        <name>POST /api/v1/auth/login</name>
        <status>implemented</status>
        <file>backend/app/api/v1/auth.py:87-153</file>
        <description>Login with JWT cookie, session storage, rate limiting. Reference pattern for new endpoints.</description>
      </interface>
      <interface type="api">
        <name>POST /api/v1/auth/logout</name>
        <status>implemented</status>
        <file>backend/app/api/v1/auth.py:156-191</file>
        <description>Logout with session invalidation. Pattern for session cleanup.</description>
      </interface>
      <interface type="service">
        <name>AuditService</name>
        <status>implemented</status>
        <file>backend/app/services/audit_service.py</file>
        <description>Fire-and-forget audit logging. Use audit_service.log_event() for all auditable actions.</description>
        <method>log_event(action, resource_type, user_id, resource_id, details, ip_address)</method>
      </interface>
      <interface type="service">
        <name>RedisSessionStore</name>
        <status>implemented</status>
        <file>backend/app/core/redis.py:67-168</file>
        <description>Session storage with store_session, get_session, invalidate_session methods. Needs extension for bulk invalidation.</description>
      </interface>
      <interface type="manager">
        <name>UserManager</name>
        <status>implemented</status>
        <file>backend/app/core/auth.py:29-84</file>
        <description>FastAPI-Users UserManager with hooks. on_after_forgot_password hook available for password reset logging.</description>
      </interface>
    </existing-interfaces>

    <data-models>
      <model name="User">
        <file>backend/app/models/user.py</file>
        <description>SQLAlchemy User model extending FastAPI-Users base. Fields: id, email, hashed_password, is_active, is_superuser, is_verified, created_at, updated_at.</description>
      </model>
      <model name="UserRead">
        <file>backend/app/schemas/user.py:10-24</file>
        <description>Pydantic schema for reading user data. Inherits FastAPI-Users BaseUser. Includes created_at.</description>
      </model>
      <model name="UserUpdate">
        <file>backend/app/schemas/user.py:41-52</file>
        <description>Pydantic schema for updating user. Inherits FastAPI-Users BaseUserUpdate. May need extension for profile fields.</description>
      </model>
      <model name="AuditEvent">
        <file>backend/app/models/audit.py</file>
        <description>Audit event in audit schema. Fields: id, timestamp, user_id, action, resource_type, resource_id, details, ip_address.</description>
      </model>
    </data-models>

    <constraints>
      <constraint type="security">
        <description>Password reset token expires in 1 hour (configurable via FastAPI-Users)</description>
        <reference>FastAPI-Users default: reset_password_token_secret in UserManager</reference>
      </constraint>
      <constraint type="security">
        <description>Password minimum 8 characters (already enforced in UserCreate schema)</description>
        <reference>backend/app/schemas/user.py:38</reference>
      </constraint>
      <constraint type="security">
        <description>All sessions must be invalidated on password change to prevent unauthorized access</description>
        <reference>Story AC4, AC7</reference>
      </constraint>
      <constraint type="audit">
        <description>All profile/password changes must be logged to audit.events</description>
        <reference>FR4, FR56, Story AC9</reference>
      </constraint>
      <constraint type="api">
        <description>Follow existing API patterns: /api/v1/ prefix, snake_case for JSON, proper HTTP status codes</description>
        <reference>docs/architecture.md - API Design section</reference>
      </constraint>
    </constraints>
  </technical-context>

  <dependencies>
    <dependency type="library">
      <name>fastapi-users[sqlalchemy]</name>
      <version>&gt;=14.0.0,&lt;15.0.0</version>
      <purpose>Authentication framework with built-in password reset support</purpose>
      <usage>Use fastapi_users.get_reset_password_router() or implement manually with UserManager hooks</usage>
    </dependency>
    <dependency type="library">
      <name>redis</name>
      <version>&gt;=7.1.0,&lt;8.0.0</version>
      <purpose>Session storage and bulk session invalidation</purpose>
      <usage>RedisSessionStore for session management</usage>
    </dependency>
    <dependency type="library">
      <name>structlog</name>
      <version>&gt;=25.5.0,&lt;26.0.0</version>
      <purpose>Structured logging for password reset email mock</purpose>
      <usage>logger.info("password_reset_requested", token=token, user_id=user_id)</usage>
    </dependency>
    <dependency type="story">
      <name>Story 1.4: User Registration and Authentication Backend</name>
      <status>done</status>
      <provides>Auth infrastructure, UserManager, RedisSessionStore, AuditService</provides>
    </dependency>
  </dependencies>

  <testing-guidance>
    <test-patterns>
      <pattern name="Integration Test Structure">
        <description>Follow existing test_auth.py pattern with per-test database and Redis fixtures</description>
        <file>backend/tests/integration/test_auth.py</file>
      </pattern>
      <pattern name="Auth Client Fixture">
        <description>Use auth_client fixture that provides test database and Redis with proper cleanup</description>
        <example>async def test_patch_users_me(auth_client, registered_user): ...</example>
      </pattern>
      <pattern name="Registered User Fixture">
        <description>Use registered_user fixture that creates and logs in a test user</description>
        <file>backend/tests/integration/test_auth.py:94-101</file>
      </pattern>
    </test-patterns>

    <test-cases>
      <test-case ac-ref="AC1" priority="high">
        <name>test_get_users_me_returns_profile_info</name>
        <description>Verify GET /users/me returns email, created_at (already tested in test_auth.py)</description>
        <status>existing</status>
      </test-case>
      <test-case ac-ref="AC2" priority="high">
        <name>test_patch_users_me_updates_profile</name>
        <description>Login, PATCH /users/me with new email, verify update persisted</description>
      </test-case>
      <test-case ac-ref="AC2" priority="high">
        <name>test_patch_users_me_creates_audit_event</name>
        <description>Verify audit.events contains profile update record after PATCH</description>
      </test-case>
      <test-case ac-ref="AC3" priority="high">
        <name>test_forgot_password_generates_token</name>
        <description>POST /forgot-password with valid email, verify 202 Accepted response</description>
      </test-case>
      <test-case ac-ref="AC3" priority="medium">
        <name>test_forgot_password_nonexistent_email_returns_success</name>
        <description>POST /forgot-password with nonexistent email returns 202 (no information leakage)</description>
      </test-case>
      <test-case ac-ref="AC4" priority="high">
        <name>test_reset_password_with_valid_token_updates_password</name>
        <description>Generate token, POST /reset-password with token and new password, verify login works with new password</description>
      </test-case>
      <test-case ac-ref="AC4,AC7" priority="high">
        <name>test_reset_password_invalidates_all_sessions</name>
        <description>Login from two sessions, reset password, verify both sessions are invalid</description>
      </test-case>
      <test-case ac-ref="AC5" priority="high">
        <name>test_reset_password_with_invalid_token_returns_400</name>
        <description>POST /reset-password with fake token, verify 400 response</description>
      </test-case>
      <test-case ac-ref="AC5" priority="medium">
        <name>test_reset_password_with_expired_token_returns_400</name>
        <description>Generate token, wait/mock expiry, POST /reset-password, verify 400</description>
      </test-case>
      <test-case ac-ref="AC6" priority="medium">
        <name>test_patch_users_me_invalid_email_returns_422</name>
        <description>PATCH /users/me with malformed email, verify 422</description>
      </test-case>
      <test-case ac-ref="AC8" priority="high">
        <name>test_patch_users_me_without_auth_returns_401</name>
        <description>PATCH /users/me without cookie, verify 401</description>
      </test-case>
      <test-case ac-ref="AC9" priority="medium">
        <name>test_password_reset_creates_audit_events</name>
        <description>Verify audit events for forgot-password and reset-password actions</description>
      </test-case>
    </test-cases>

    <test-utilities>
      <utility name="redis_client fixture">
        <file>backend/tests/integration/test_auth.py:23-37</file>
        <description>Provides fresh Redis client with post-test cleanup</description>
      </utility>
      <utility name="auth_client fixture">
        <file>backend/tests/integration/test_auth.py:40-81</file>
        <description>Test client with database and Redis overrides</description>
      </utility>
    </test-utilities>
  </testing-guidance>

  <implementation-notes>
    <note priority="high">
      <title>FastAPI-Users Password Reset Router</title>
      <content>FastAPI-Users provides get_reset_password_router() that handles forgot-password and reset-password endpoints. Consider using this vs. manual implementation. If using built-in router, mount at /api/v1/auth/ prefix.</content>
      <reference>https://fastapi-users.github.io/fastapi-users/latest/configuration/routers/reset-password/</reference>
    </note>
    <note priority="high">
      <title>Session Invalidation Implementation</title>
      <content>Current RedisSessionStore stores single session per user (session:uuid). For bulk invalidation, options:
1. Store session list in Redis hash per user
2. Use SCAN to find all keys (not ideal for performance)
3. Store sessions with pattern session:user_id:* and use pattern delete
Recommend option 3 for simplicity.</content>
    </note>
    <note priority="medium">
      <title>Email Mock Implementation</title>
      <content>In UserManager.on_after_forgot_password hook, log the reset token and URL using structlog. Format: logger.info("password_reset_token", user_email=user.email, token=token, reset_url=f"{base_url}/reset-password?token={token}")</content>
    </note>
    <note priority="medium">
      <title>Existing GET /users/me</title>
      <content>GET /users/me is already implemented and tested. This story adds PATCH /users/me (profile update). Keep GET implementation unchanged.</content>
    </note>
    <note priority="low">
      <title>Profile Fields</title>
      <content>Current User model has email only. If first_name/last_name needed, requires migration. For MVP, may only allow email update. Clarify scope before implementation.</content>
    </note>
  </implementation-notes>

  <related-documentation>
    <document type="prd">
      <path>docs/prd.md</path>
      <relevant-sections>FR3 (Password Reset), FR4 (Profile Update), FR56 (Audit Logging)</relevant-sections>
    </document>
    <document type="architecture">
      <path>docs/architecture.md</path>
      <relevant-sections>Security Architecture, API Design, Audit Schema</relevant-sections>
    </document>
    <document type="tech-spec">
      <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
      <relevant-sections>Section 4.3 Audit Logging, Section 4.1 Authentication</relevant-sections>
    </document>
    <document type="epics">
      <path>docs/epics.md</path>
      <relevant-sections>Story 1.5 definition (lines 318-352)</relevant-sections>
    </document>
    <document type="story">
      <path>docs/sprint-artifacts/1-5-user-profile-and-password-management-backend.md</path>
      <relevant-sections>Full story with acceptance criteria and tasks</relevant-sections>
    </document>
  </related-documentation>

  <code-references>
    <reference type="pattern">
      <description>Auth route pattern with audit logging</description>
      <file>backend/app/api/v1/auth.py</file>
      <lines>87-153</lines>
      <usage>Follow this pattern for new endpoints: request validation, business logic, background audit task</usage>
    </reference>
    <reference type="pattern">
      <description>UserManager hooks for password reset</description>
      <file>backend/app/core/auth.py</file>
      <lines>70-84</lines>
      <usage>Implement on_after_forgot_password hook for email mock logging</usage>
    </reference>
    <reference type="pattern">
      <description>Session store methods</description>
      <file>backend/app/core/redis.py</file>
      <lines>78-168</lines>
      <usage>Add invalidate_all_sessions(user_id) method for password reset</usage>
    </reference>
    <reference type="test-pattern">
      <description>Integration test fixture setup</description>
      <file>backend/tests/integration/test_auth.py</file>
      <lines>40-101</lines>
      <usage>Use same fixtures for test_users.py</usage>
    </reference>
  </code-references>
</story-context>
