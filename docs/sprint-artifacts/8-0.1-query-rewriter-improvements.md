# Story 8-0.1: Query Rewriter Improvements

Status: done

## Story

As a **user engaging in multi-turn conversations with LumiKB**,
I want **the query rewriter to better understand conversational context, tolerate typos, and preserve response formatting expectations**,
so that **follow-up questions like "how about a day after tha" correctly resolve to "What is covered on Day 7?" when discussing a study plan**.

## Problem Statement

### Observed Issues (Production Bug Report 2025-12-18)

| Issue | Description | Severity |
|-------|-------------|----------|
| **Context Loss** | Query "how about a day after tha" after discussing Phase C on Day 6 was rewritten as "What are the next steps after Day 2?" - completely losing conversation context | **HIGH** |
| **Typo Handling** | "tha" not corrected to "that" - rewriter over-interpreted instead of simple typo correction | **MEDIUM** |
| **Format Preservation** | Follow-up responses don't match the format (numbered list, headers) of previous answers | **MEDIUM** |
| **Session Persistence** | Session ID carries over on re-login; chat history not loaded when user returns | **LOW** |

### Root Cause Analysis

1. **Answer Summarization Truncates Key Info** ([query_rewriter_service.py:445-476](backend/app/services/query_rewriter_service.py#L445-L476))
   - `_summarize_answer()` takes first 800 chars of assistant response
   - Key topic info (e.g., "Day 6 / Phase C") may appear AFTER the 800-char cutoff
   - User's conversation about Day 6 is lost in summary

2. **History Formatting Loses Topic Continuity** ([query_rewriter_service.py:443](backend/app/services/query_rewriter_service.py#L443))
   - `last_user_question[:400]` truncates user's question
   - No extraction of KEY TOPICS from conversation

3. **No Typo Tolerance Instruction** in rewriter prompt
   - Prompt doesn't instruct LLM to correct obvious typos before interpretation

4. **No Format Preservation Mechanism**
   - No instruction to maintain response format consistency

## Acceptance Criteria

1. **AC-8.0.1.1**: Query rewriter correctly resolves sequential references
   - "how about next" after Day 6 discussion → "What is covered on Day 7?"
   - "and the one before" after Phase D discussion → "What is Phase C?"

2. **AC-8.0.1.2**: Query rewriter handles typos gracefully
   - "wha about tha" → Corrects to "what about that" before resolving context
   - "tel me more" → Corrects to "tell me more"

3. **AC-8.0.1.3**: Answer summarization extracts key topics, not just first N chars
   - Extract numbered items (Day 1, Day 2, etc.)
   - Extract headers (**Phase A:**, **Step 1:**, etc.)
   - Extract the LAST topic discussed (most relevant for follow-up)

4. **AC-8.0.1.4**: Rewriter prompt includes format preservation instruction
   - If previous answer was a numbered list, hint that user expects similar format
   - Example: "List the topics covered on Day 7" vs "What is Day 7 about?"

5. **AC-8.0.1.5**: Debug panel shows improved rewrite reasoning
   - Show original → rewritten transformation
   - Show extracted key topics from conversation

6. **AC-8.0.1.6**: All existing query rewriter tests continue to pass

## Tasks / Subtasks

- [x] **Task 1: Improve Answer Summarization** (AC-8.0.1.3)
  - [x] 1.1 Create `_extract_key_topics()` method to find numbered items, headers, and last topic
  - [x] 1.2 Update `_summarize_answer()` to include key topics extraction
  - [x] 1.3 Prioritize LAST topic in summary (most relevant for follow-ups)
  - [x] 1.4 Extract markdown headers (`## Day 6: Phase C`) as key topics
  - [x] 1.5 Write unit tests for key topic extraction

- [x] **Task 2: Add Typo Tolerance** (AC-8.0.1.2)
  - [x] 2.1 Update REWRITE_PROMPT with typo correction instruction
  - [x] 2.2 Add rule: "Correct obvious typos (e.g., 'tha'→'that', 'wha'→'what') before interpretation"
  - [x] 2.3 Write unit tests for typo correction

- [x] **Task 3: Add Sequential Reference Examples** (AC-8.0.1.1)
  - [x] 3.1 Add few-shot examples for sequential follow-ups:
    ```
    Previous: "Day 6 covers Phase C: Data and Application Architecture..."
    User: "how about the day after"
    Rewrite: "What is covered on Day 7 of the study plan?"
    ```
  - [x] 3.2 Add examples for "next", "previous", "before that", "after that"
  - [x] 3.3 Write unit tests for sequential reference resolution

- [x] **Task 4: Add Format Preservation Instruction** (AC-8.0.1.4)
  - [x] 4.1 Update REWRITE_PROMPT with format preservation rule
  - [x] 4.2 Rule: "If previous answer used numbered list format, phrase query to elicit similar format"
  - [x] 4.3 Add format hint to rewritten queries where appropriate
  - [x] 4.4 Write unit tests for format preservation

- [x] **Task 5: Update Debug Panel** (AC-8.0.1.5)
  - [x] 5.1 Add `extracted_topics` field to QueryRewriteDebugInfo
  - [x] 5.2 Display extracted topics in debug panel
  - [x] 5.3 Show "Topics: [Day 6, Phase C]" when available

- [x] **Task 6: Tests** (AC-8.0.1.6)
  - [x] 6.1 Ensure all 33 existing unit tests pass (AC-8.0.1.6)
  - [x] 6.2 Add 16 new unit tests across 4 test classes (AC-8.0.1.6)
  - [x] 6.3 Total: 49 unit tests passing

## Dev Notes

### Learnings from Previous Story (Story 8-0)

> **Source:** [docs/sprint-artifacts/8-0-history-aware-query-rewriting.md](docs/sprint-artifacts/8-0-history-aware-query-rewriting.md) (Completion Notes lines 205-254)

**Files Created in Story 8-0 (now being MODIFIED):**
- `backend/app/services/query_rewriter_service.py` (NEW - 266 lines) - Core rewriter service with RewriteResult dataclass, `rewrite_with_history()` method, pronoun detection heuristics
- `backend/tests/unit/test_query_rewriter_service.py` (NEW - 17 tests)
- `backend/tests/integration/test_query_rewriter_api.py` (NEW - 10 tests)

**Architecture Patterns Established (must preserve):**
1. **Service Injection**: QueryRewriterService injected into ConversationService via constructor
2. **Graceful Degradation**: Timeout/error defaults to original query - never blocks chat
3. **LiteLLM Routing**: Uses existing LiteLLM client with model path like `openai/db-{uuid}`
4. **Config Lookup**: Rewriter model resolved from system_config at call time (not cached long)

**Bug Fix Applied in Story 8-0 (line 244-249):**
- **Issue**: `obs.log_llm_call()` was called with wrong parameter `trace_id=trace_ctx.trace_id` instead of `ctx=trace_ctx`
- **Impact**: TypeError during metric logging triggered graceful degradation, returning original query
- **Learning**: Always use `ctx=trace_ctx` when calling observability methods (not `trace_id=`)

**Existing Methods to Extend (not replace):**
- `_summarize_answer()` at line 445-476 - Currently takes first 800 chars; add topic extraction
- `_format_history()` at line 443 - Currently truncates to 400 chars; preserve but enhance
- `_is_standalone()` - Pronoun/reference detection heuristics; extend for sequential refs

### Improved Rewriter Prompt (Draft)

```python
REWRITE_PROMPT = """Given a chat history and the latest user question, reformulate
the question as a standalone query that can be understood without the chat history.

## Rules

1. PRONOUNS: Resolve all pronouns (he/she/it/they) to specific entities from history
2. REFERENCES: Expand implicit references ("the same thing", "that", "above") to actual topics
3. SEQUENTIAL: "next", "previous", "after that" → Identify the sequence and compute target
   - If discussing "Day 6", then "next" means "Day 7"
   - If discussing "Phase C", then "before that" means "Phase B"
4. TYPOS: Correct obvious typos BEFORE interpreting
   - "tha" → "that", "wha" → "what", "tel" → "tell", "teh" → "the"
5. NO ANSWERING: Only reformulate - never answer the question
6. STANDALONE: If question is already standalone, return it unchanged
7. CONCISE: Keep reformulated question similar length to original
8. FORMAT HINTS: If previous answer was a numbered list, phrase query to elicit similar format
   - "List the topics covered on Day 7" vs "What is Day 7 about?"

## Examples

Example 1 - Pronoun Resolution:
History:
  Human: Tell me about Tim Cook
  Assistant: Tim Cook is the CEO of Apple Inc...
Question: How old is he?
Reformulated: How old is Tim Cook?

Example 2 - Sequential Reference:
History:
  Human: Tell me about Day 6 in the study plan
  Assistant: Day 6 covers Phase C: Data and Application Architecture...
Question: how about a day after tha
Reformulated: What is covered on Day 7 of the study plan?

Example 3 - Previous Reference:
History:
  Human: What is Phase D about?
  Assistant: Phase D covers Technology Architecture...
Question: and the one before
Reformulated: What is Phase C about in the TOGAF framework?

Example 4 - Typo Correction:
History:
  Human: Explain TOGAF
  Assistant: TOGAF is The Open Group Architecture Framework...
Question: tel me more about teh ADM
Reformulated: Tell me more about the ADM in TOGAF

Example 5 - Standalone (no change):
History: (empty)
Question: What is the capital of France?
Reformulated: What is the capital of France?
"""
```

### Key Topic Extraction Algorithm

```python
def _extract_key_topics(self, text: str) -> list[str]:
    """Extract key topics from assistant response."""
    topics = []

    # 1. Extract markdown headers
    headers = re.findall(r'^##?\s*(.+?)$', text, re.MULTILINE)
    topics.extend(headers[:3])  # First 3 headers

    # 2. Extract numbered items (Day 1, Step 1, Phase A, etc.)
    numbered = re.findall(r'(?:Day|Step|Phase|Chapter)\s+\d+[A-Z]?', text, re.IGNORECASE)
    topics.extend(numbered[-3:])  # Last 3 items (most recent context)

    # 3. Extract bold topics
    bold = re.findall(r'\*\*([^*]+)\*\*', text)
    topics.extend(bold[:3])

    return list(set(topics))[:5]  # Dedupe, max 5 topics
```

### Session Management Fixes (Lower Priority)

Session issues are **separate from query rewriting** but affect UX:

1. **Session ID on Re-login** - Defer to separate story
2. **Chat History Loading** - Defer to separate story

Focus this story purely on query rewriter improvements.

### Test Cases

| Test Case | Input | Expected Rewrite |
|-----------|-------|------------------|
| Sequential continuation | "how about next" after Day 6 | "What is covered on Day 7?" |
| Previous reference | "and the one before" after Phase D | "What is Phase C?" |
| Typo handling | "wha about tha" | "what about that" then resolve |
| Multiple typos | "tel me mroe about teh ADM" | "Tell me more about the ADM" |
| Format preservation | Follow-up after numbered list | Query hinting list format |
| Already standalone | "What is TOGAF?" (no history) | "What is TOGAF?" (unchanged) |

### References

- [Source: Story 8-0 implementation - Completion Notes](docs/sprint-artifacts/8-0-history-aware-query-rewriting.md#L205-L254) - Architecture patterns, bug fixes, deferred items
- [Source: query_rewriter_service.py - _summarize_answer()](backend/app/services/query_rewriter_service.py#L445-L476) - Answer truncation logic to modify
- [Source: query_rewriter_service.py - _format_history()](backend/app/services/query_rewriter_service.py#L443) - History formatting to enhance
- [Source: query_rewriter_service.py - REWRITE_PROMPT](backend/app/services/query_rewriter_service.py#L50-L115) - Prompt to extend with new rules
- [Source: conversation_service.py - send_message_stream()](backend/app/services/conversation_service.py) - Integration point for rewriter
- [Source: frontend/src/types/debug.ts - QueryRewriteDebugInfo](frontend/src/types/debug.ts) - Schema to extend
- [Bug Report: TOGAF KB conversation issues 2025-12-18] - Production issue triggering this story

## Story Points

**Estimated: 5 points** (Medium complexity - prompt engineering + testing)

## Dependencies

- Story 8-0 (History-Aware Query Rewriting) - **COMPLETED**

## Risks

1. **LLM Variability**: Prompt changes may have unintended effects on other scenarios
   - Mitigation: Comprehensive regression testing with existing test suite

2. **Performance**: Key topic extraction adds processing time
   - Mitigation: Keep extraction simple, cache results if needed

## Dev Agent Record

### Context Reference

- [docs/sprint-artifacts/8-0.1-query-rewriter-improvements.context.xml](docs/sprint-artifacts/8-0.1-query-rewriter-improvements.context.xml)

### Agent Model Used

Claude claude-opus-4-5-20251101 (Scrum Master Agent)

### Completion Notes List

**Completed: 2025-12-18**

#### Summary

All 6 acceptance criteria have been implemented:
- **AC-8.0.1.1**: Sequential reference resolution via improved prompts with examples
- **AC-8.0.1.2**: Typo tolerance via TYPOS rule in prompts
- **AC-8.0.1.3**: Key topic extraction via `_extract_key_topics()` method
- **AC-8.0.1.4**: Format preservation via FORMAT_HINTS rule in prompts
- **AC-8.0.1.5**: Debug panel shows extracted topics with Badge components
- **AC-8.0.1.6**: 49 unit tests pass (33 existing + 16 new)

#### Key Implementation Details

1. **`_extract_key_topics()` Method** ([query_rewriter_service.py:478-538](backend/app/services/query_rewriter_service.py#L478-L538))
   - Extracts markdown headers (##, ###) - first 3
   - Extracts numbered items (Day N, Phase X, Step N) - last 3 (most relevant for "next" queries)
   - Extracts bold text (**topic**) - first 3
   - Deduplicates and returns max 5 topics

2. **`RewriteResult` Dataclass Extended**
   - Added `extracted_topics: list[str] = field(default_factory=list)` field
   - Uses `dataclass` with `field(default_factory=list)` to avoid mutable default

3. **Prompt Improvements**
   - TYPOS rule: "Correct obvious typos BEFORE interpreting"
   - SEQUENTIAL rule with examples for "next", "previous", "before that", "after that"
   - FORMAT_HINTS rule: "If previous answer was numbered/bulleted list, phrase query to elicit similar format"

4. **`_extract_conversation_context()` Return Type Changed**
   - Now returns 4-tuple: `(last_user_question, last_assistant_answer, earlier_summary, extracted_topics)`
   - All callers updated to unpack 4 values

5. **Debug Panel Updates**
   - Added `extracted_topics` field to `QueryRewriteDebugInfo` schema (backend + frontend)
   - Display extracted topics as Badge components in debug-info-panel.tsx

#### New Test Classes Added

| Test Class | Tests | Purpose |
|------------|-------|---------|
| TestExtractKeyTopics | 6 | Validate header, numbered item, bold text extraction |
| TestSummarizeAnswerWithTopics | 3 | Validate topic appending to summaries |
| TestRewriteResultWithExtractedTopics | 2 | Validate dataclass field |
| TestPromptImprovements | 5 | Validate prompt rules present |

#### Files Modified

| File | Changes |
|------|---------|
| `backend/app/services/query_rewriter_service.py` | Added `_extract_key_topics()`, updated prompts, updated `_summarize_answer()`, updated `_extract_conversation_context()` |
| `backend/app/schemas/chat.py` | Added `extracted_topics` field to `QueryRewriteDebugInfo` |
| `backend/app/services/conversation_service.py` | Pass `extracted_topics` to debug info |
| `frontend/src/types/debug.ts` | Added `extracted_topics?: string[]` to interface |
| `frontend/src/components/chat/debug-info-panel.tsx` | Display extracted topics with Badge components |
| `backend/tests/unit/test_query_rewriter_service.py` | Added 16 new tests, fixed 4 existing tests for 4-tuple return |

#### Ruff Linting Fix

Fixed `E713` error: Changed `not x in set` to `x not in set` at line 523

### File List

**Backend - To Be Modified (files created in Story 8-0):**
- `backend/app/services/query_rewriter_service.py` [From Story 8-0: NEW, 266 lines] - Update REWRITE_PROMPT, add `_extract_key_topics()`, enhance `_summarize_answer()`
- `backend/tests/unit/test_query_rewriter_service.py` [From Story 8-0: NEW, 17 tests] - Add 8 new test cases for sequential refs, typos, topic extraction, format preservation

**Frontend - To Be Modified (files modified in Story 8-0):**
- `frontend/src/types/debug.ts` [From Story 8-0: MODIFIED] - Add `extracted_topics: string[]` to QueryRewriteDebugInfo interface
- `frontend/src/components/chat/debug-info-panel.tsx` [From Story 8-0: MODIFIED, added query_rewrite section] - Display extracted topics in debug panel
