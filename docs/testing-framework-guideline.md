# LumiKB Testing Framework Guideline

**Generated by**: TEA (Master Test Architect)
**Date**: 2025-11-24
**Last Updated**: 2025-11-24
**Project**: LumiKB - RAG-powered Knowledge Base Application
**Current Epic**: Epic 2 (Knowledge Base & Document Management)

---

## Table of Contents

1. [Current State Assessment](#current-state-assessment)
2. [Technology Stack](#technology-stack)
3. [Test Infrastructure Overview](#test-infrastructure-overview)
4. [TEA Commands Reference](#tea-commands-reference)
5. [Recommended Workflow](#recommended-workflow)
6. [Phased Testing Strategy](#phased-testing-strategy)
7. [Gaps and Recommendations](#gaps-and-recommendations)
8. [Next Steps](#next-steps)
9. [Quick Reference Commands](#quick-reference-commands)

---

## Current State Assessment

| Metric | Status | Risk Level |
|--------|--------|------------|
| Backend Unit Tests | 11 files | Medium |
| Backend Integration Tests | 17 files | Good |
| Frontend Component Tests | 185 files | Good |
| E2E Tests | 3 specs only | **High Gap** |
| CI Pipeline | Automated (unit/integration) | Good |
| E2E in CI | Manual trigger only | Medium |
| Coverage Threshold | 70% configured | Good |
| Contract Testing | Not implemented | **Gap** |
| NFR Testing | Not documented | **Gap** |
| Test Traceability | No matrix exists | **Gap** |

---

## Technology Stack

| Aspect | Technology | Version | Notes |
|--------|-----------|---------|-------|
| **Backend Testing** | pytest | 8.0.0+ | Async support, markers for test levels |
| **Backend Coverage** | pytest-cov | 5.0.0+ | HTML + lcov reports, 70% threshold |
| **Backend Async** | pytest-asyncio | 0.24.0+ | Auto async mode |
| **Backend Containers** | testcontainers | 4.0.0+ | postgres, redis support |
| **Frontend Testing** | Vitest | 4.0.13 | jsdom environment |
| **Frontend Testing Library** | @testing-library/react | 16.3.0 | React 19 compatible |
| **E2E Testing** | Playwright | 1.56.1 | Chromium, Firefox, WebKit capable |
| **Code Quality** | ruff | 0.8.0+ | Python linting + formatting |
| **Code Quality** | ESLint | 9.0+ | JavaScript/TypeScript linting |
| **Code Quality** | Prettier | 3.6.2 | Code formatting |
| **Pre-commit** | pre-commit | 4.0.0+ | Hooks for ruff, eslint, prettier |
| **CI Platform** | GitHub Actions | Latest | test.yml + e2e.yml workflows |

---

## Test Infrastructure Overview

### Backend Tests (Python/pytest)

**Location**: `/backend/tests/`

**Structure**:
```
backend/tests/
├── conftest.py              # Global fixtures
├── factories/               # Test data factories
│   ├── user_factory.py
│   ├── kb_factory.py
│   └── document_factory.py
├── fixtures/                # Sample test files
├── unit/                    # Unit tests (no external deps)
│   └── conftest.py          # Auto-marks as @pytest.mark.unit
└── integration/             # Integration tests (with containers)
    └── conftest.py          # Testcontainers setup
```

**Test Markers**:
- `@pytest.mark.unit` - Fast, isolated tests
- `@pytest.mark.integration` - Tests with database/services
- `@pytest.mark.smoke` - Critical path validation
- `@pytest.mark.slow` - Long-running tests

**Configuration** (from `pyproject.toml`):
- Coverage threshold: 70% for statements, branches, functions, lines
- Timeout: 90 seconds default, 30s for unit, 120s for integration
- Async mode: Auto

### Frontend Tests (TypeScript/Vitest + Playwright)

**Location**: `/frontend/src/**/*.test.{ts,tsx}` and `/frontend/e2e/`

**Structure**:
```
frontend/
├── src/
│   ├── test/
│   │   ├── setup.ts         # Vitest setup, global mocks
│   │   └── test-utils.tsx   # Custom render utilities
│   └── **/*.test.{ts,tsx}   # Component/unit tests
└── e2e/
    ├── playwright.config.ts
    ├── fixtures/            # Playwright fixtures
    ├── pages/               # Page objects
    └── specs/               # E2E test specs
        ├── auth/
        └── documents/
```

**Configuration** (from `vitest.config.ts`):
- Environment: jsdom
- Coverage threshold: 70%
- Test timeout: 10 seconds

### CI/CD Pipeline

**GitHub Actions Workflows**:

1. **test.yml** (Automated on push/PR):
   - `lint-backend` → `lint-frontend` → `test-unit` → `test-integration` → `test-frontend` → `coverage`

2. **e2e.yml** (Manual dispatch):
   - Full stack E2E tests with Playwright
   - Environment selection: local or staging

---

## TEA Commands Reference

### 1. `*framework` - Initialize Test Framework Architecture

**When to use**: At project start OR when restructuring test infrastructure

**What it does**:
- Analyzes your stack (FastAPI + Next.js + Playwright)
- Generates a production-ready test architecture document
- Defines folder structures, naming conventions, fixture patterns
- Establishes test levels (unit/integration/e2e boundaries)

**Output**: Test architecture document with patterns and conventions

---

### 2. `*atdd` - Acceptance Test-Driven Development

**When to use**: BEFORE implementing a new story/feature (Phase 4)

**What it does**:
- Takes a story/requirement as input
- Generates E2E test specs (Playwright) FIRST
- Tests define the acceptance criteria in executable form
- You implement until tests pass

**Example flow**:
```
Story: "User uploads document to knowledge base"
→ *atdd generates: e2e/documents/upload.spec.ts
→ You implement: upload API + UI
→ Tests pass = Story done
```

---

### 3. `*test-design` - Create Comprehensive Test Scenarios

**When to use**: When you need to plan test coverage for a feature/epic

**What it does**:
- Analyzes requirements (from story/epic/PRD)
- Generates test scenarios across all levels (unit, integration, e2e)
- Applies risk-based prioritization (P0-P3)
- Outputs a test design document with scenarios mapped to requirements

**Output**: `test-design-{epic/story}.md`

---

### 4. `*automate` - Generate Comprehensive Test Automation

**When to use**: After implementation is complete, to fill coverage gaps

**What it does**:
- Scans existing code and tests
- Identifies untested paths and edge cases
- Generates test code (pytest for backend, Vitest/Playwright for frontend)
- Applies patterns from knowledge base (fixture architecture, data factories)

**Output**: Generated test files ready for review

---

### 5. `*trace` - Requirements Traceability Matrix

**When to use**: Before release gate decisions (Phase 4 completion)

**What it does**:
- **Phase 1**: Maps requirements → test cases (bidirectional traceability)
- **Phase 2**: Makes quality gate decision (GO/NO-GO)
- Outputs a traceability matrix showing coverage gaps
- Archives compliance evidence

**Output**: Traceability matrix + GO/NO-GO recommendation

---

### 6. `*nfr-assess` - Non-Functional Requirements Assessment

**When to use**: Before major releases or when validating architecture

**What it does**:
- Reviews against NFR categories: Security, Performance, Reliability, Maintainability
- Uses `nfr-criteria.md` knowledge base for assessment
- Identifies gaps in non-functional test coverage
- Outputs NFR assessment report

**NFR Categories**:
- Security (authentication, authorization, data protection)
- Performance (response times, throughput, resource usage)
- Reliability (error handling, recovery, availability)
- Maintainability (code quality, documentation, testability)

---

### 7. `*ci` - Scaffold CI/CD Quality Pipeline

**When to use**: When setting up or improving CI pipelines

**What it does**:
- Analyzes your stack and existing CI config
- Generates/improves GitHub Actions workflows
- Adds quality gates: lint → unit → integration → e2e → coverage
- Configures artifact retention, caching, parallelization

**Improvements it can add**:
- Automate E2E on PRs (not just manual dispatch)
- Add SAST/DAST security scanning
- Add flaky test detection
- Optimize caching and parallelization

---

### 8. `*test-review` - Review Test Quality

**When to use**: After writing tests, before merging PRs

**What it does**:
- Reviews test code against quality standards
- Checks for: flakiness patterns, proper assertions, isolation, naming
- Uses full knowledge base (21 patterns) for comprehensive review
- Outputs improvement recommendations

**Quality Criteria**:
- Test isolation and independence
- Proper assertions and error messages
- Naming conventions
- Flakiness risk assessment
- Performance considerations

---

## Recommended Workflow

### Development Phase Workflow

```
┌─────────────────────────────────────────────────────────┐
│  PHASE 3 (If restructuring needed)                      │
│  *framework → Document/improve test architecture        │
│  *ci → Enhance CI pipeline (automate E2E, add security) │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  PHASE 4 (Per Story)                                    │
│  1. *test-design → Plan scenarios for the story         │
│  2. *atdd → Generate E2E tests BEFORE implementation    │
│  3. Implement code until tests pass                     │
│  4. *automate → Fill unit/integration coverage gaps     │
│  5. *test-review → Quality check the tests              │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  RELEASE GATE (Per Epic)                                │
│  *trace → Build traceability matrix + GO/NO-GO decision │
│  *nfr-assess → Validate non-functional requirements     │
└─────────────────────────────────────────────────────────┘
```

### Priority Matrix

| Priority | Command | Action | Impact |
|----------|---------|--------|--------|
| High | `*trace` | Create traceability matrix before release | Proves coverage |
| High | `*automate` | Generate unit/integration tests | Fills coverage gaps |
| Medium | `*test-design` | Document test scenarios (including deferred E2E) | Planning |
| Medium | `*nfr-assess` | Document NFR gaps | Risk visibility |
| Medium | `*test-review` | Review existing test quality | Quality assurance |
| Deferred | `*atdd` | Generate E2E tests (requires Docker) | Epic 5 |
| Deferred | `*ci` (E2E) | Automate E2E in pipeline (requires Docker) | Epic 5 |

---

## Phased Testing Strategy

### Constraint: Docker Infrastructure

E2E tests require full-stack orchestration (backend + PostgreSQL + Redis + Qdrant + MinIO). Docker Compose setup is planned for **Epic 5**. Until then, we maximize coverage with unit and integration tests.

### Epic 2-4: Maximize Non-E2E Coverage

```
┌─────────────────────────────────────────────────────────────────────┐
│  AVAILABLE NOW (No Docker Required)                                 │
│                                                                     │
│  Unit Tests (pytest)         → No external dependencies             │
│  Integration Tests (pytest)  → Testcontainers for postgres/redis   │
│  Component Tests (Vitest)    → jsdom environment                   │
│  API Contract Tests          → Mock-based validation                │
└─────────────────────────────────────────────────────────────────────┘
```

**TEA Commands Available Now**:

| Command | Docker Required | Use Case |
|---------|-----------------|----------|
| `*test-design` | No | Plan ALL test scenarios (document E2E for later) |
| `*automate` | No | Generate unit + integration tests |
| `*trace` | No | Map requirements to existing tests |
| `*test-review` | No | Review test quality |
| `*nfr-assess` | No | Document NFR gaps |
| `*framework` | No | Document test architecture |

### Epic 5: Full E2E Implementation

```
┌─────────────────────────────────────────────────────────────────────┐
│  EPIC 5: Docker + E2E                                               │
│                                                                     │
│  1. Docker Compose orchestration for full stack                    │
│  2. *atdd → Generate executable E2E specs (Playwright)             │
│  3. *ci → Add E2E to GitHub Actions with Docker                    │
│  4. *trace → Complete traceability with E2E coverage               │
└─────────────────────────────────────────────────────────────────────┘
```

### Testing Coverage by Epic

| Epic | Unit Tests | Integration Tests | E2E Tests | Notes |
|------|------------|-------------------|-----------|-------|
| Epic 1 (Auth) | Available | Available | 3 specs exist | Foundation complete |
| Epic 2 (KB/Docs) | Generate now | Generate now | Design only | `*automate` |
| Epic 3 (Search) | Generate now | Generate now | Design only | `*automate` |
| Epic 4 (Chat) | Generate now | Generate now | Design only | `*automate` |
| Epic 5 (Infra) | N/A | N/A | Execute all | `*atdd`, `*ci` |

---

## Gaps and Recommendations

### Critical Gaps

1. **E2E Test Coverage**: Only 3 Playwright specs for a full-featured RAG application
   - Missing: Document upload, KB management, chat flows
   - **Action**: Design E2E scenarios now with `*test-design`, implement in Epic 5 with `*atdd`

2. **Manual E2E Execution**: E2E workflow requires manual dispatch
   - **Action**: Defer to Epic 5 - use `*ci` after Docker setup

3. **Test Traceability**: No matrix linking requirements to tests
   - **Action**: Use `*trace` before each Epic completion

4. **NFR Testing**: No documented non-functional requirements testing
   - **Action**: Use `*nfr-assess` to identify and document gaps

### Medium Priority Gaps

5. **Contract Testing**: API contract testing not implemented
   - Consider Pact for frontend/backend contract validation
   - Can be implemented now (no Docker required)

6. **Security Testing**: No SAST/DAST in CI pipeline
   - Add dependency scanning, code analysis
   - Can enhance CI now with `*ci` for non-E2E security gates

7. **Performance Testing**: No load/stress tests
   - Consider k6 or Locust for API performance testing
   - Defer to Epic 5 (requires full stack)

### Strengths to Maintain

- Comprehensive test architecture documentation (21 patterns in `.bmad/bmm/testarch/`)
- Well-structured testing levels with clear separation
- Factory pattern for test data with parallel-safety
- Pre-commit hooks for quality enforcement
- Automated CI with coverage reporting
- Testcontainers for database integration tests (works without full Docker Compose)

---

## Next Steps

### Immediate Actions (Epic 2 In Progress)

Execute these TEA commands in order to maximize test coverage without Docker:

#### Step 1: Assess Current Coverage
```
*trace
```
- Maps Epic 2 requirements to existing tests
- Identifies which acceptance criteria are covered
- Flags gaps that need unit/integration tests now vs E2E later

#### Step 2: Generate Missing Tests
```
*automate
```
- Generates unit tests for new services (document_service, kb_service)
- Generates integration tests for API endpoints
- Uses existing factory patterns for test data

#### Step 3: Review Test Quality
```
*test-review
```
- Reviews generated and existing tests against quality standards
- Identifies flakiness risks and isolation issues
- Provides improvement recommendations

#### Step 4: Document NFR Gaps
```
*nfr-assess
```
- Documents security, performance, reliability gaps
- Creates actionable items for Epic 5

### Per-Story Workflow (Epics 2-4)

For each new story, follow this sequence:

```
┌─────────────────────────────────────────────────────────────────────┐
│  1. *test-design                                                    │
│     - Plan test scenarios for the story                            │
│     - Document E2E scenarios (for Epic 5 implementation)           │
│     - Identify unit/integration tests to write NOW                 │
│                                                                     │
│  2. Implement the story                                             │
│     - Write code with unit tests                                   │
│     - Run: make test-unit                                          │
│                                                                     │
│  3. *automate                                                       │
│     - Fill coverage gaps                                           │
│     - Generate edge case tests                                     │
│                                                                     │
│  4. *test-review                                                    │
│     - Quality check before merge                                   │
│     - Run: make test-integration                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### Epic Completion Gate

Before marking any Epic as complete:

```
*trace
```
- Verify all acceptance criteria have test coverage
- Document any deferred E2E tests
- Make GO/NO-GO recommendation

### Epic 5 Testing Roadmap

When Docker infrastructure is ready:

| Order | Command | Action |
|-------|---------|--------|
| 1 | `*ci` | Add E2E to GitHub Actions with Docker Compose |
| 2 | `*atdd` | Generate E2E specs for all deferred scenarios |
| 3 | `*trace` | Complete full traceability matrix |
| 4 | `*nfr-assess` | Validate performance/security with full stack |

### Recommended Command Sequence Summary

| When | Command | Purpose |
|------|---------|---------|
| Now | `*trace` | See current Epic 2 coverage |
| Now | `*automate` | Generate unit/integration tests |
| Per Story | `*test-design` | Plan scenarios before coding |
| Before Merge | `*test-review` | Quality gate |
| Epic Complete | `*trace` | Verify coverage, GO/NO-GO |
| Epic 5 | `*atdd` + `*ci` | Full E2E implementation |

---

## Quick Reference Commands

### Makefile Commands

```bash
# Backend Tests
make test                    # Run all tests (backend + frontend)
make test-backend            # All backend tests
make test-unit               # Backend unit tests only
make test-integration        # Backend integration tests
make test-coverage           # Backend tests + coverage report

# Frontend Tests
make test-frontend           # Frontend tests (run once)
make test-frontend-watch     # Frontend tests (watch mode)
make test-frontend-coverage  # Frontend tests with coverage

# E2E Tests
make test-e2e                # Playwright E2E tests
make test-e2e-ui             # Playwright UI mode
make test-e2e-headed         # Headed browser mode

# Quality
make lint                    # Linting (ruff + eslint)
```

### TEA Agent Commands

```
*help              - Show menu
*workflow-status   - Check workflow status
*framework         - Initialize test framework
*atdd              - Generate E2E tests before implementation
*automate          - Generate test automation
*test-design       - Create test scenarios
*trace             - Requirements traceability matrix
*nfr-assess        - NFR assessment
*ci                - CI/CD pipeline scaffold
*test-review       - Test quality review
*exit              - Exit TEA agent
```

---

## Knowledge Base Reference

The TEA agent has access to 21 specialized testing knowledge fragments in `.bmad/bmm/testarch/knowledge/`:

| Fragment | Description |
|----------|-------------|
| `fixture-architecture.md` | Composable fixture patterns |
| `network-first.md` | Network intercept and mocking |
| `data-factories.md` | Test data factory patterns |
| `component-tdd.md` | React component TDD workflow |
| `playwright-config.md` | Playwright configuration |
| `ci-burn-in.md` | CI stability and burn-in |
| `selective-testing.md` | Risk-based test selection |
| `contract-testing.md` | API contract testing (Pact) |
| `test-levels-framework.md` | Unit/integration/e2e guidelines |
| `test-priorities-matrix.md` | P0-P3 prioritization |
| `test-healing-patterns.md` | Flaky test remediation |
| `selector-resilience.md` | Robust selector strategies |
| `timing-debugging.md` | Race condition debugging |
| `risk-governance.md` | Risk scoring and gates |
| `nfr-criteria.md` | NFR assessment criteria |
| `test-quality.md` | Test quality definition of done |

---

*This document is maintained by the TEA (Master Test Architect) agent. Update by running TEA commands to regenerate sections as the project evolves.*
