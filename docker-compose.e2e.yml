# LumiKB E2E Testing Docker Compose
# Story 7-1: Docker E2E Infrastructure
#
# Usage:
#   docker-compose -f docker-compose.e2e.yml up -d
#   docker-compose -f docker-compose.e2e.yml exec backend python seed_e2e.py
#
# Services: frontend, backend, celery-worker, postgres, redis, qdrant, minio, litellm
#
# NOTE: Ollama runs on host machine with GPU support (Docker Desktop doesn't support GPU passthrough)
# Start Ollama on host before running E2E tests: ollama serve
# Pull required models: ollama pull nomic-embed-text && ollama pull gemma3:4b

services:
  # =============================================================================
  # Frontend - Next.js Production Build
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.e2e
    container_name: lumikb-e2e-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:8000
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - e2e-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # Backend - FastAPI Application
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    container_name: lumikb-e2e-backend
    environment:
      # Database
      LUMIKB_DATABASE_URL: postgresql+asyncpg://e2e_user:e2e_pass@postgres:5432/e2e_lumikb
      # Redis
      LUMIKB_REDIS_URL: redis://redis:6379/0
      # MinIO
      LUMIKB_MINIO_ENDPOINT: minio:9000
      LUMIKB_MINIO_ACCESS_KEY: e2e_minio
      LUMIKB_MINIO_SECRET_KEY: e2e_minio_secret
      LUMIKB_MINIO_SECURE: "false"
      # Qdrant
      LUMIKB_QDRANT_HOST: qdrant
      LUMIKB_QDRANT_PORT: "6333"
      # LiteLLM
      LUMIKB_LITELLM_URL: http://litellm:4000
      LUMIKB_LITELLM_API_KEY: sk-e2e-test-key
      # Auth settings
      LUMIKB_SECRET_KEY: e2e-test-secret-key-do-not-use-in-production
      LUMIKB_CORS_ORIGINS: '["http://localhost:3000","http://frontend:3000"]'
      # E2E mode flag
      LUMIKB_E2E_MODE: "true"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
      minio:
        condition: service_healthy
    networks:
      - e2e-network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # =============================================================================
  # Celery Worker - Background Task Processing
  # =============================================================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: lumikb-e2e-celery-worker
    command: >
      celery -A app.workers.celery_app worker
      --loglevel=info
      --queues=default,document_processing
      --concurrency=2
    environment:
      LUMIKB_DATABASE_URL: postgresql+asyncpg://e2e_user:e2e_pass@postgres:5432/e2e_lumikb
      LUMIKB_REDIS_URL: redis://redis:6379/0
      LUMIKB_CELERY_BROKER_URL: redis://redis:6379/0
      LUMIKB_CELERY_RESULT_BACKEND: redis://redis:6379/0
      LUMIKB_MINIO_ENDPOINT: minio:9000
      LUMIKB_MINIO_ACCESS_KEY: e2e_minio
      LUMIKB_MINIO_SECRET_KEY: e2e_minio_secret
      LUMIKB_QDRANT_HOST: qdrant
      LUMIKB_QDRANT_PORT: "6333"
      LUMIKB_LITELLM_URL: http://litellm:4000
      LUMIKB_LITELLM_API_KEY: sk-e2e-test-key
      LUMIKB_E2E_MODE: "true"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
      minio:
        condition: service_healthy
      litellm:
        condition: service_healthy
    networks:
      - e2e-network

  # =============================================================================
  # PostgreSQL - Test Database
  # =============================================================================
  postgres:
    image: postgres:16
    container_name: lumikb-e2e-postgres
    environment:
      POSTGRES_USER: e2e_user
      POSTGRES_PASSWORD: e2e_pass
      POSTGRES_DB: e2e_lumikb
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U e2e_user -d e2e_lumikb"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network
    # No volume - ephemeral test data

  # =============================================================================
  # Redis - Session and Task Broker
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: lumikb-e2e-redis
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - e2e-network
    # No volume - ephemeral test data

  # =============================================================================
  # Qdrant - Vector Search
  # =============================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: lumikb-e2e-qdrant
    ports:
      - "6334:6333"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/localhost/6333 && echo -e \"GET /readyz HTTP/1.0\\r\\n\\r\\n\" >&3 && cat <&3 | grep -q ready'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network
    # No volume - ephemeral test data

  # =============================================================================
  # MinIO - Document Storage (S3-compatible)
  # =============================================================================
  minio:
    image: minio/minio:latest
    container_name: lumikb-e2e-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: e2e_minio
      MINIO_ROOT_PASSWORD: e2e_minio_secret
    ports:
      - "9002:9000"
      - "9003:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network
    # No volume - ephemeral test data

  # =============================================================================
  # LiteLLM - LLM API Proxy
  # =============================================================================
  # NOTE: Ollama runs on host machine with GPU support (Docker Desktop doesn't support GPU passthrough)
  # Start Ollama on host: ollama serve
  # Pull embedding model: ollama pull nomic-embed-text
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: lumikb-e2e-litellm
    volumes:
      - ./infrastructure/docker/litellm_config.yaml:/app/config.yaml:ro
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    ports:
      - "4001:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      LITELLM_MASTER_KEY: sk-e2e-test-key
      # Provider API keys (optional - tests should work without real LLM)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      # Ollama runs on host machine - use host.docker.internal to reach it from container
      OLLAMA_API_BASE: http://host.docker.internal:11434
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:4000/health/readiness')\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - e2e-network
    depends_on:
      - redis

# =============================================================================
# Networks
# =============================================================================
networks:
  e2e-network:
    driver: bridge
    name: lumikb-e2e-network

# =============================================================================
# Named Volumes for E2E Testing
# =============================================================================
# No volumes needed - all test data is ephemeral
